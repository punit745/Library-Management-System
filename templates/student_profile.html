{% extends "base.html" %}

{% block title %}{{ student.name }} - Profile | BookNest{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Student Profile</h2>
</div>

<div class="profile-container">
    <div class="profile-card">
        <div class="profile-header">
            <div class="profile-avatar">{{ student.name[:1].upper() if student.name else '?' }}</div>
            <div class="profile-info">
                <h2>{{ student.name }}</h2>
                <p class="admission-badge">Admission No: {{ student.admission_number }}</p>
            </div>
        </div>

        <div class="profile-details">
            <div class="detail-item">
                <span class="detail-label">Course</span>
                <span class="detail-value">{{ student.course }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Email</span>
                <span class="detail-value">{{ student.email or 'Not provided' }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Total Books Issued</span>
                <span class="detail-value">{{ issues|length }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Currently Borrowed</span>
                <span class="detail-value">{{ current_issues|length }}</span>
            </div>
        </div>
    </div>

    {% if total_fine > 0 %}
    <div class="fine-alert">
        <div class="fine-icon">‚ö†Ô∏è</div>
        <div class="fine-content">
            <h3>Outstanding Fine</h3>
            <p class="fine-amount-large">‚Çπ{{ "%.2f"|format(total_fine) }}</p>
            <p class="fine-note">Fine is calculated at ‚Çπ20/day after the 12-day grace period expires.</p>
        </div>
    </div>
    {% endif %}

    <div class="form-card" style="margin-top: 1.5rem;">
        <h3>üìö Issue New Book to {{ student.name }}</h3>
        <form method="POST"
            action="{{ url_for('students.issue_book_to_student', admission_number=student.admission_number) }}">
            <div class="barcode-section"
                style="background-color: #f0f8ff; padding: 1rem; border-radius: 5px; margin-bottom: 1rem; border-left: 4px solid #3498db;">
                <h4 style="margin-bottom: 0.5rem; color: #2c3e50;">üì∑ Scan Barcode (Optional)</h4>
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="barcode_scan">Enter Book Code or Barcode:</label>
                    <input type="text" id="barcode_scan" name="barcode_scan" placeholder="e.g., 010001 or LIB010001"
                        style="font-family: monospace;">
                    <small style="color: #666;">If provided, this will override the book selection below</small>
                </div>
            </div>

            <div class="form-group">
                <label for="book_id">OR Select Book Manually:</label>
                <select id="book_id" name="book_id">
                    <option value="">Choose a book</option>
                    {% for book in available_books %}
                    <option value="{{ book.id }}">{{ book.book_code }} - {{ book.title }} by {{ book.author }} ({{
                        book.book_type }})</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="issue_duration">Issue Duration:</label>
                <select id="issue_duration" name="issue_duration">
                    <option value="default">Default (Book's duration setting)</option>
                    <option value="1">1 day</option>
                    <option value="3">3 days</option>
                    <option value="7">7 days</option>
                    <option value="15">15 days</option>
                    <option value="30">30 days (1 month)</option>
                    <option value="90">90 days (Whole semester)</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Issue Book</button>
        </form>
    </div>
</div>

<div class="table-container">
    <h3>Currently Borrowed Books</h3>
    {% if current_issues %}
    <table>
        <thead>
            <tr>
                <th>Book Code</th>
                <th>Title</th>
                <th>Type</th>
                <th>Issue Date</th>
                <th>Due Date</th>
                <th>Days Issued</th>
                <th>Grace Days Left</th>
                <th>Fine</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for issue in current_issues %}
            <tr {% if issue.fine> 0 %}class="overdue"{% endif %}>
                <td><code style="font-weight: bold;">{{ issue.book.book_code }}</code></td>
                <td>{{ issue.book.title }}</td>
                <td>{{ issue.book.book_type }}</td>
                <td>{{ issue.issue_date.strftime('%Y-%m-%d') }}</td>
                <td>{{ issue.due_date.strftime('%Y-%m-%d') }}</td>
                <td>{{ issue.get_days_issued() }} days</td>
                <td>
                    {% if issue.get_grace_days_remaining() > 0 %}
                    <span class="status-badge available">{{ issue.get_grace_days_remaining() }} days</span>
                    {% else %}
                    <span class="status-badge unavailable">Expired</span>
                    {% endif %}
                </td>
                <td>
                    {% if issue.fine > 0 %}
                    <span class="fine-amount">‚Çπ{{ "%.2f"|format(issue.fine) }}</span>
                    {% else %}
                    ‚Çπ0.00
                    {% endif %}
                </td>
                <td>
                    <form method="POST"
                        action="{{ url_for('students.return_book_from_profile', admission_number=student.admission_number, issue_id=issue.id) }}"
                        style="display:inline;">
                        <button type="submit" class="btn btn-success">Return</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="no-data">No books currently borrowed.</p>
    {% endif %}
</div>

<div class="table-container">
    <h3>Borrowing History</h3>
    {% if returned_issues %}
    <table>
        <thead>
            <tr>
                <th>Book Code</th>
                <th>Title</th>
                <th>Type</th>
                <th>Issue Date</th>
                <th>Return Date</th>
                <th>Duration</th>
                <th>Fine Paid</th>
            </tr>
        </thead>
        <tbody>
            {% for issue in returned_issues %}
            <tr>
                <td><code>{{ issue.book.book_code }}</code></td>
                <td>{{ issue.book.title }}</td>
                <td>{{ issue.book.book_type }}</td>
                <td>{{ issue.issue_date.strftime('%Y-%m-%d') }}</td>
                <td>{{ issue.return_date.strftime('%Y-%m-%d') if issue.return_date else 'N/A' }}</td>
                <td>{{ issue.get_days_issued() }} days</td>
                <td>
                    {% if issue.fine > 0 %}
                    <span class="fine-amount">‚Çπ{{ "%.2f"|format(issue.fine) }}</span>
                    {% else %}
                    ‚Çπ0.00
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="no-data">No borrowing history available.</p>
    {% endif %}
</div>

<div class="profile-actions">
    <a href="{{ url_for('students.manage_students') }}" class="btn btn-primary">‚Üê Back to Students</a>
</div>
{% endblock %}