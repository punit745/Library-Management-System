{% extends "base.html" %}

{% block title %}Issue & Return Books{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Issue & Return Books</h2>
</div>

<div class="form-card">
    <h3>Issue New Book</h3>

    <!-- Student Search - Merged and simplified -->
    <div class="form-group search-select-container" style="margin-bottom: 1.5rem;">
        <label for="student-search-input" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
            üîç Search Student by Admission Number:
        </label>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="text" id="student-search-input" class="search-box"
                placeholder="Enter admission number and press Enter..." autocomplete="off"
                style="flex: 1; font-size: 1rem; padding: 0.75rem;">
        </div>
        <small style="color: #666; margin-top: 0.5rem; display: block;">
            üí° Type admission number and press <kbd
                style="background: #e0e0e0; padding: 2px 6px; border-radius: 3px;">Enter</kbd> to go directly to student
            profile
        </small>

        <!-- Student match display -->
        <div id="student-match-display"
            style="margin-top: 0.75rem; padding: 0.75rem; background: #e8f5e9; border-radius: 5px; display: none; border-left: 4px solid #4caf50;">
            <span id="student-match-info" style="font-weight: 500;"></span>
            <a id="quick-profile-link" href="#" style="margin-left: 1rem; color: #1976d2; text-decoration: none;">
                üë§ View Profile
            </a>
        </div>

        <!-- No match display -->
        <div id="student-no-match"
            style="margin-top: 0.75rem; padding: 0.75rem; background: #ffebee; border-radius: 5px; display: none; border-left: 4px solid #f44336;">
            <span style="color: #c62828;">‚ö†Ô∏è No student found with this admission number</span>
        </div>
    </div>

    <form method="POST" action="{{ url_for('issues.issue_book') }}">
        <!-- Hidden field for student ID -->
        <input type="hidden" id="student_id" name="student_id" value="">

        <!-- Student Selection Display (shows selected student) -->
        <div class="form-group">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Selected Student:</label>
            <div id="selected-student-display"
                style="padding: 0.75rem; background: #f5f5f5; border-radius: 5px; color: #666;">
                No student selected. Use search above or select from dropdown below.
            </div>
        </div>

        <!-- Dropdown as fallback -->
        <div class="form-group">
            <label for="student-dropdown" style="display: block; margin-bottom: 0.5rem;">
                Or Select from List:
            </label>
            <select id="student-dropdown" style="width: 100%;">
                <option value="">Choose a student...</option>
                {% for student in students %}
                <option value="{{ student.id }}" data-name="{{ student.name }}"
                    data-admission="{{ student.admission_number }}" data-course="{{ student.course }}">
                    {{ student.admission_number }} - {{ student.name }} ({{ student.course }})
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="barcode-section"
            style="background-color: #f0f8ff; padding: 1rem; border-radius: 5px; margin-bottom: 1rem; border-left: 4px solid #3498db;">
            <h4 style="margin-bottom: 0.5rem; color: #2c3e50;">üì∑ Scan Barcode (Optional)</h4>
            <div class="form-group" style="margin-bottom: 0;">
                <label for="barcode_scan">Enter Book Code or Barcode:</label>
                <input type="text" id="barcode_scan" name="barcode_scan" placeholder="e.g., 010001 or LIB010001"
                    style="font-family: monospace;">
                <small style="color: #666;">If provided, this will override the book selection below</small>
            </div>
        </div>

        <div class="form-group">
            <label for="book_id">OR Select Book Manually:</label>
            <select id="book_id" name="book_id">
                <option value="">Choose a book</option>
                {% for book in books %}
                <option value="{{ book.id }}">{{ book.book_code }} - {{ book.title }} by {{ book.author }} ({{
                    book.book_type }})</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="issue_duration">Issue Duration:</label>
            <select id="issue_duration" name="issue_duration">
                <option value="default">Default (Book's duration setting)</option>
                <option value="1">1 day</option>
                <option value="3">3 days</option>
                <option value="7">7 days</option>
                <option value="15">15 days</option>
                <option value="30">30 days (1 month)</option>
                <option value="90">90 days (Whole semester)</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Issue Book</button>
    </form>
</div>

<div class="form-card" style="background-color: #f0fff0; border-left: 4px solid #27ae60;">
    <h3>üì• Return Book by Barcode</h3>
    <p style="color: #666; margin-bottom: 1rem;">Scan or enter the book code/barcode to quickly return a book</p>
    <form method="POST" action="{{ url_for('issues.return_book_by_barcode') }}">
        <div class="form-group">
            <label for="return_barcode">Book Code or Barcode:</label>
            <input type="text" id="return_barcode" name="return_barcode" placeholder="e.g., 010001 or LIB010001"
                required style="font-family: monospace; font-size: 1.1rem;">
        </div>
        <button type="submit" class="btn btn-success">Return Book</button>
    </form>
</div>

<div class="table-container">
    <h3>Currently Issued Books</h3>
    {% if issues %}
    <table>
        <thead>
            <tr>
                <th>Issue ID</th>
                <th>Book Code</th>
                <th>Student (Admission No.)</th>
                <th>Book</th>
                <th>Issue Date</th>
                <th>Due Date</th>
                <th>Days Issued</th>
                <th>Grace Days Left</th>
                <th>Fine</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for issue in issues %}
            <tr {% if issue.fine> 0 %}class="overdue"{% endif %}>
                <td>{{ issue.id }}</td>
                <td><code style="font-weight: bold;">{{ issue.book.book_code }}</code></td>
                <td>{{ issue.student.name }}<br><small>({{ issue.student.admission_number }})</small></td>
                <td>{{ issue.book.title }}</td>
                <td>{{ issue.issue_date.strftime('%Y-%m-%d') }}</td>
                <td>{{ issue.due_date.strftime('%Y-%m-%d') }}</td>
                <td>{{ issue.get_days_issued() }} days</td>
                <td>
                    {% if issue.get_grace_days_remaining() > 0 %}
                    <span style="color: #27ae60;">{{ issue.get_grace_days_remaining() }} days</span>
                    {% else %}
                    <span style="color: #e74c3c;">Expired</span>
                    {% endif %}
                </td>
                <td>
                    {% if issue.fine > 0 %}
                    <span class="fine-amount">‚Çπ{{ "%.2f"|format(issue.fine) }}</span>
                    {% else %}
                    ‚Çπ0.00
                    {% endif %}
                </td>
                <td>
                    <form method="POST" action="{{ url_for('issues.return_book', id=issue.id) }}"
                        style="display:inline;">
                        <button type="submit" class="btn btn-success">Return</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="no-data">No books currently issued.</p>
    {% endif %}
</div>

<div class="info-box">
    <h4>Information</h4>
    <ul>
        <li><strong>Barcode System:</strong> Each book has a unique 6-digit code (2-digit category + 4-digit number) and
            barcode</li>
        <li><strong>Quick Issue/Return:</strong> Scan or enter book code/barcode to quickly issue or return books</li>
        <li>Books can be issued for custom durations: 7 days, 15 days, 30 days, or whole semester (90 days)</li>
        <li>Default duration for semester books is 14 days unless custom duration is selected</li>
        <li>Students have a 12-day grace period starting from the due date to return or re-issue the book</li>
        <li>After the grace period expires, a fine of ‚Çπ20 per day is automatically applied</li>
        <li>Track days issued and grace days remaining for each book</li>
        <li>Search students by name or admission number for quick book issuing</li>
        <li>Return books on time to avoid penalties</li>
    </ul>
</div>

<script>
    // Store student data for quick lookup
    const studentsData = {};
    document.querySelectorAll('#student-dropdown option').forEach(option => {
        const admission = option.getAttribute('data-admission');
        if (admission) {
            studentsData[admission] = {
                id: option.value,
                name: option.getAttribute('data-name'),
                admission: admission,
                course: option.getAttribute('data-course')
            };
        }
    });

    // Elements
    const searchInput = document.getElementById('student-search-input');
    const studentIdField = document.getElementById('student_id');
    const studentDropdown = document.getElementById('student-dropdown');
    const matchDisplay = document.getElementById('student-match-display');
    const matchInfo = document.getElementById('student-match-info');
    const quickProfileLink = document.getElementById('quick-profile-link');
    const noMatchDisplay = document.getElementById('student-no-match');
    const selectedStudentDisplay = document.getElementById('selected-student-display');

    // Handle search input
    searchInput.addEventListener('input', function () {
        const query = this.value.trim();

        if (!query) {
            hideMatches();
            clearSelection();
            return;
        }

        // Check for exact match
        const student = studentsData[query];
        if (student) {
            showMatch(student);
            selectStudent(student);
        } else {
            // Check for partial match
            const partialMatch = Object.values(studentsData).find(s =>
                s.admission.startsWith(query) || s.admission.includes(query)
            );

            if (partialMatch && query.length >= 3) {
                showMatch(partialMatch, true);
            } else if (query.length >= 3) {
                showNoMatch();
            } else {
                hideMatches();
            }
        }
    });

    // Handle Enter key - redirect to profile
    searchInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const query = this.value.trim();

            if (query && studentsData[query]) {
                // Exact match - redirect to profile
                window.location.href = `/students/profile/${query}`;
            } else {
                // Try partial match
                const match = Object.values(studentsData).find(s =>
                    s.admission.startsWith(query) || s.admission.includes(query)
                );
                if (match) {
                    window.location.href = `/students/profile/${match.admission}`;
                } else {
                    showNoMatch();
                }
            }
        }
    });

    // Handle dropdown change
    studentDropdown.addEventListener('change', function () {
        const selectedOption = this.options[this.selectedIndex];
        if (this.value) {
            const student = {
                id: this.value,
                name: selectedOption.getAttribute('data-name'),
                admission: selectedOption.getAttribute('data-admission'),
                course: selectedOption.getAttribute('data-course')
            };
            selectStudent(student);
            searchInput.value = student.admission;
            showMatch(student);
        } else {
            clearSelection();
            hideMatches();
        }
    });

    function showMatch(student, isPartial = false) {
        matchDisplay.style.display = 'block';
        noMatchDisplay.style.display = 'none';

        const prefix = isPartial ? 'üîé Partial match: ' : '‚úÖ Found: ';
        matchInfo.innerHTML = `${prefix}<strong>${student.name}</strong> (${student.admission}) - ${student.course}`;
        quickProfileLink.href = `/students/profile/${student.admission}`;
    }

    function showNoMatch() {
        matchDisplay.style.display = 'none';
        noMatchDisplay.style.display = 'block';
    }

    function hideMatches() {
        matchDisplay.style.display = 'none';
        noMatchDisplay.style.display = 'none';
    }

    function selectStudent(student) {
        studentIdField.value = student.id;
        studentDropdown.value = student.id;
        selectedStudentDisplay.innerHTML = `<strong style="color: #2e7d32;">‚úì ${student.name}</strong> (${student.admission}) - ${student.course}`;
        selectedStudentDisplay.style.background = '#e8f5e9';
    }

    function clearSelection() {
        studentIdField.value = '';
        studentDropdown.value = '';
        selectedStudentDisplay.innerHTML = 'No student selected. Use search above or select from dropdown below.';
        selectedStudentDisplay.style.background = '#f5f5f5';
    }

    // Focus search input on page load
    document.addEventListener('DOMContentLoaded', function () {
        searchInput.focus();
    });
</script>
{% endblock %}