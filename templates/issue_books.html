{% extends "base.html" %}

{% block title %}Issue & Return Books{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Issue & Return Books</h2>
</div>

<div class="form-card">
    <h3>Issue New Book</h3>
    <form method="POST" action="{{ url_for('issues.issue_book') }}">
        <div class="form-group search-select-container">
            <label for="student-search" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Search & Select Student:</label>
            <input type="text" id="student-search" class="search-box" placeholder="Type to search by name or admission number..." aria-label="Search student by name or admission number" oninput="filterStudents()">
            <select id="student_id" name="student_id" required>
                <option value="">Choose a student</option>
                {% for student in students %}
                <option value="{{ student.id }}" data-name="{{ student.name|lower }}" data-admission="{{ student.admission_number }}">{{ student.admission_number }} - {{ student.name }} ({{ student.course }})</option>
                {% endfor %}
            </select>
            <small style="color: #666; margin-top: 0.3rem; display: block;">Start typing to filter students by name or admission number</small>
        </div>
        
        <div class="barcode-section" style="background-color: #f0f8ff; padding: 1rem; border-radius: 5px; margin-bottom: 1rem; border-left: 4px solid #3498db;">
            <h4 style="margin-bottom: 0.5rem; color: #2c3e50;">ðŸ“· Scan Barcode (Optional)</h4>
            <div class="form-group" style="margin-bottom: 0;">
                <label for="barcode_scan">Enter Book Code or Barcode:</label>
                <input type="text" id="barcode_scan" name="barcode_scan" placeholder="e.g., 010001 or LIB010001" style="font-family: monospace;">
                <small style="color: #666;">If provided, this will override the book selection below</small>
            </div>
        </div>
        
        <div class="form-group">
            <label for="book_id">OR Select Book Manually:</label>
            <select id="book_id" name="book_id">
                <option value="">Choose a book</option>
                {% for book in books %}
                <option value="{{ book.id }}">{{ book.book_code }} - {{ book.title }} by {{ book.author }} ({{ book.book_type }})</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="issue_duration">Issue Duration:</label>
            <select id="issue_duration" name="issue_duration">
                <option value="default">Default (Book's duration setting)</option>
                <option value="7">7 days</option>
                <option value="15">15 days</option>
                <option value="30">30 days (1 month)</option>
                <option value="90">90 days (Whole semester)</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Issue Book</button>
    </form>
</div>

<div class="form-card" style="background-color: #f0fff0; border-left: 4px solid #27ae60;">
    <h3>ðŸ“¥ Return Book by Barcode</h3>
    <p style="color: #666; margin-bottom: 1rem;">Scan or enter the book code/barcode to quickly return a book</p>
    <form method="POST" action="{{ url_for('issues.return_book_by_barcode') }}">
        <div class="form-group">
            <label for="return_barcode">Book Code or Barcode:</label>
            <input type="text" id="return_barcode" name="return_barcode" placeholder="e.g., 010001 or LIB010001" required style="font-family: monospace; font-size: 1.1rem;">
        </div>
        <button type="submit" class="btn btn-success">Return Book</button>
    </form>
</div>

<div class="table-container">
    <h3>Currently Issued Books</h3>
    {% if issues %}
    <table>
        <thead>
            <tr>
                <th>Issue ID</th>
                <th>Book Code</th>
                <th>Student (Admission No.)</th>
                <th>Book</th>
                <th>Issue Date</th>
                <th>Due Date</th>
                <th>Days Issued</th>
                <th>Grace Days Left</th>
                <th>Fine</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for issue in issues %}
            <tr {% if issue.fine > 0 %}class="overdue"{% endif %}>
                <td>{{ issue.id }}</td>
                <td><code style="font-weight: bold;">{{ issue.book.book_code }}</code></td>
                <td>{{ issue.student.name }}<br><small>({{ issue.student.admission_number }})</small></td>
                <td>{{ issue.book.title }}</td>
                <td>{{ issue.issue_date.strftime('%Y-%m-%d') }}</td>
                <td>{{ issue.due_date.strftime('%Y-%m-%d') }}</td>
                <td>{{ issue.get_days_issued() }} days</td>
                <td>
                    {% if issue.get_grace_days_remaining() > 0 %}
                        <span style="color: #27ae60;">{{ issue.get_grace_days_remaining() }} days</span>
                    {% else %}
                        <span style="color: #e74c3c;">Expired</span>
                    {% endif %}
                </td>
                <td>
                    {% if issue.fine > 0 %}
                        <span class="fine-amount">â‚¹{{ "%.2f"|format(issue.fine) }}</span>
                    {% else %}
                        â‚¹0.00
                    {% endif %}
                </td>
                <td>
                    <form method="POST" action="{{ url_for('issues.return_book', id=issue.id) }}" style="display:inline;">
                        <button type="submit" class="btn btn-success">Return</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="no-data">No books currently issued.</p>
    {% endif %}
</div>

<div class="info-box">
    <h4>Information</h4>
    <ul>
        <li><strong>Barcode System:</strong> Each book has a unique 6-digit code (2-digit category + 4-digit number) and barcode</li>
        <li><strong>Quick Issue/Return:</strong> Scan or enter book code/barcode to quickly issue or return books</li>
        <li>Books can be issued for custom durations: 7 days, 15 days, 30 days, or whole semester (90 days)</li>
        <li>Default duration for semester books is 14 days unless custom duration is selected</li>
        <li>Students have a 12-day grace period starting from the due date to return or re-issue the book</li>
        <li>After the grace period expires, a fine of â‚¹20 per day is automatically applied</li>
        <li>Track days issued and grace days remaining for each book</li>
        <li>Search students by name or admission number for quick book issuing</li>
        <li>Return books on time to avoid penalties</li>
    </ul>
</div>

<script>
function filterStudents() {
    const searchInput = document.getElementById('student-search');
    const studentSelect = document.getElementById('student_id');
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    for (let option of studentSelect.options) {
        if (option.value === '') {
            option.style.display = '';
            continue;
        }
        
        const name = option.getAttribute('data-name') || '';
        const admission = option.getAttribute('data-admission') || '';
        
        const matches = name.includes(searchTerm) || admission.includes(searchTerm);
        option.style.display = matches ? '' : 'none';
        
        // Auto-select on exact admission number match
        if (admission === searchTerm && searchTerm.length > 0) {
            studentSelect.value = option.value;
        }
    }
}
</script>
{% endblock %}
